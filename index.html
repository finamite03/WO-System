<!DOCTYPE html>
<html>
<head>
<style>
    * {
        font-family: 'Poppins', sans-serif;
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    :root {
        --primary-color: #e50914; /* Red */
        --secondary-color: #ff1493; /* Hot Pink */
        --background-dark: #181818; /* Dark Background */
        --background-light: #222222; /* Lighter Dark Background */
        --text-color: #ffffff; /* White Text */
        --border-color: #333333; /* Dark Border */
        --input-background: #333333; /* Input Background */
    }

    body {
        background-color: var(--background-dark);
        color: var(--text-color);
        position: relative;
    }

    .tabs {
        display: flex;
        background-color: var(--background-light);
        padding: 10px;
        border-bottom: 1px solid var(--border-color);
    }

    .tab-button {
        padding: 12px 24px;
        cursor: pointer;
        border: none;
        background-color: transparent;
        color: var(--text-color);
        font-size: 16px;
        transition: all 0.3s ease;
        position: relative;
        border-bottom: 3px solid transparent;
    }

    .tab-button.active {
        color: var(--primary-color);
        border-bottom: 3px solid var(--primary-color);
    }

    .tab-button.active::after {
        content: '';
        position: absolute;
        bottom: -3px;
        left: 50%;
        transform: translateX(-50%);
        width: 60%;
        height: 3px;
        background-color: var(--primary-color);
        border-radius: 2px;
    }

    .content {
        padding: 2rem;
        background-color: var(--background-dark);
        min-height: 100vh;
        position: relative;
        z-index: 1;
    }

    .section {
        display: none;
        animation: slideIn 0.5s ease;
        background: var(--background-light);
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .section.active {
        display: block;
    }

    .container {
        max-width: 100%;
        margin: 0;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
    }

    .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: linear-gradient(135deg, var(--background-dark), var(--primary-color));
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        color: #ffffff;
    }

    .header img {
        height: 50px;
    }

    .header h1 {
        margin: 0;
        font-size: 24px;
        font-weight: 600;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: #ffffff;
    }

    .date-container {
        display: flex;
        gap: 20px;
    }

    .date-group {
        flex: 1;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px;
        background-color: var(--input-background);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        color: var(--text-color);
        transition: all 0.3s ease;
        box-sizing: border-box;
        max-height: 50px;
        overflow: auto;
    }

    .form-group textarea:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(229, 9, 20, 0.2);
        outline: none;
    }

    table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: 20px;
    }

    th, td {
        padding: 12px;
        text-align: center;
        border: 1px solid var(--border-color);
    }

    th {
        background-color: var(--primary-color);
        color: #ffffff;
        font-weight: 600;
    }

    td input, td select {
        width: 90%;
        padding: 8px;
        background-color: var(--input-background);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        color: var(--text-color);
    }

    .btn {
        padding: 12px 24px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .btn:hover {
        background-color: #c82333;
        box-shadow: 0 6px 12px rgba(229, 9, 20, 0.3);
        transform: translateY(-2px);
    }

    .btn:disabled {
        background-color: #666;
        cursor: not-allowed;
    }

    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary-color);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 0.5s linear infinite;
    }

    .success-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.7);
        background: #222222;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
        z-index: 1001;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        text-align: center;
        border: 2px solid var(--primary-color);
    }

    .success-popup.show {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
        visibility: visible;
    }

    .filters {
        display: flex;
        justify-content: center;
        margin: 2% 0;
        background-color: var(--background-light);
        padding: 1% 2%;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .filters div {
        display: flex;
        align-items: center;
        margin-right: 15px;
    }

    .filters label {
        margin-right: 5px;
        font-weight: 500;
        color: #ffffff;
    }

    .filters input {
        padding: 5px;
        border-radius: 4px;
        border: 1px solid #ccc;
        transition: all 0.3s ease;
    }

    .filters input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(229, 9, 20, 0.2);
        outline: none;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        background-color: var(--background-dark);
        border: 1px solid #888;
        width: 80%;
        max-width: 800px;
        margin: 15% auto;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px); /* Glass Blur Effect */
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

    .modal-header {
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--background-dark), var(--primary-color));
        padding: 10px;
        border-radius: 8px 8px 0 0;
        margin-bottom: 20px;
        color: #ffffff;
    }

    .modal-header h2 {
        margin: 0;
        text-align: center;
        flex-grow: 1;
        font-size: 20px;
    }

    .modal-header img {
        height: 40px;
        width: auto;
        position: absolute;
        top: 10px;
        left: 20px;
        object-fit: contain;
    }

    .order-details {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        overflow-y: auto;
    }

    .order-details table {
        width: 100%;
        table-layout: auto;
        border-collapse: collapse;
        margin-top: 10px;
    }

    .order-details th,
    .order-details td {
        border: 1px solid #ddd;
        padding: 6px;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .order-details th {
        position: sticky;
        top: 0;
        z-index: 5;
        pointer-events: none;
    }

    .order-details th {
        background-color: var(--primary-color);
        color: white;
        font-weight: bold;
    }

    .order-header {
        background-color: var(--primary-color);
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 5px;
        color: #ffffff;
    }

    .header-details {
        display: flex;
        flex-wrap: wrap;
    }

    .header-details p {
        margin: 5px 0;
        flex-basis: calc(50% - 10px);
    }

    .dropdown-list {
        list-style-type: none;
        padding: 0;
        margin: 0;
        background-color: #fff;
        border: 1px solid #ddd;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        position: absolute;
        z-index: 1001;
        width: 200px;
        border-radius: 5px;
    }

    .dropdown-list li {
        padding: 10px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .dropdown-list li:hover {
        background-color: #f0f0f0;
    }

    .dropdown-list a {
        text-decoration: none;
        color: var(--text-color);
        display: block;
        width: 100%;
        height: 100%;
    }

    .dropdown-list a:hover {
        color: var(--primary-color);
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .blur-background {
        backdrop-filter: blur(10px);
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.2);
    }
</style>

</head>
<body>

<div class="tabs">
    <button class="tab-button active" onclick="showSection('section1')">Create Work Order</button>
    <button class="tab-button" onclick="showSection('StatusUpdate')">Dispatch & Status Update</button>
    <button class="tab-button" onclick="showSection('MASTER')">Work Order Master</button>
    <button class="tab-button" onclick="showSection('EDITABLE_DASHBOARD')">Edit</button>
    <button class="tab-button" onclick="toggleDropdown('section2-dropdown')">Print Section</button>
    <ul id="section2-dropdown" class="dropdown-list" style="display: none;">
        <li><a href="#" onclick="showSection('print-work-order')">FOR PLANTS</a></li>
        <li><a href="#" onclick="showSection('for-print-mgt-container')">FOR MANAGEMENT</a></li>
    </ul>
</div>


<div class="content">

<div id="section1" class="section">
<div class="success-popup" id="success-popup">
    <div class="checkmark"></div>
    <h2 style="color: white; margin-bottom: 20px;">Submitted Successfully!</h2>
    <p style="color: #888; margin-bottom: 30px;" id="success-message">
        Your order has been submitted.
    </p>
    <button class="btn" onclick="closeSuccessPopup()">Continue</button>
</div>


    <div class="container">
        <div class="header">
            <img src="https://mahajangroup.com/wp-content/uploads/2015/09/logo.png" alt="Logo">
            <h1>Work Order System : Create Work Order</h1>
        </div>

        <form id="work-order-form">
            <div class="form-group">
                <label for="customer-name"><b>Customer Name*</b></label>
                <select id="customer-name" required>
                    <option value=""><b>Select Customer</b></option>
                </select>
            </div>
            <div class="form-group">
          <label for="work-order-number"><b>Work Order Number*</b></label>
          <input type="text" id="work-order-number" readonly>
          </div>

            <div class="date-container">
                <div class="date-group">
                    <label for="issue-date"><b>Issue Date*</b></label>
                    <input type="date" id="issue-date" required>
                </div>
                <div class="date-group">
                    <label for="delivery-date"><b>Delivery Date</b></label>
                    <input type="date" id="delivery-date">
                </div>
            </div>

            <div class="form-group">
                <label for="remarks"><b>Remarks*</b></label>
                <textarea id="remarks" required rows="4"></textarea>
            </div>    
            <table id="data-table">
                <thead>
                    <tr>
                        <th>Size*</th>
                        <th>Tolerance*</th>
                        <th>Grade*</th>
                        <th>Quantity (MT)*</th>
                        <th>Rate*</th>
                        <th>Hb/HHb*</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" name="size[]" required></td>
                        <td><input type="text" name="tolerance[]" required></td>
                        <td>
                            <select name="grade[]" required>
                                <option value="">Grade</option>
                            </select>
                        </td>
                        <td><input type="number" step="0.001" name="quantity[]" required></td>
                        <td><input type="number" step="0.01" name="rate[]" required></td>
                        <td>
                            <select name="hb_hhb[]" required>
                                <option value="">Type</option>
                                <option value="Hb">Hb</option>
                                <option value="HHb">HHb</option>
                                <option value="A/Phos">A/Phos</option>
                            </select>
                        </td>
                        <td><button type="button" class="btn remove-row">Remove</button></td>
                    </tr>
                </tbody>
            </table>

            <div style="margin-top: 20px; text-align: center;">
                <button type="button" class="btn" id="add-row-btn">Add Row</button>
                <button type="submit" class="btn" id="submit-btn">Submit</button>
            </div>
        </form>
    </div>

    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

<script>
    // Utility function for form validation
    function validateForm(form) {
        const requiredFields = form.querySelectorAll('[required]');
        for (let field of requiredFields) {
            // Enhanced validation with trimming and specific checks
            if (!field.value || (field.value.trim() === '')) {
                field.classList.add('error');
                field.focus();
                
                // Create or update error message
                let errorEl = field.nextElementSibling;
                if (!errorEl || !errorEl.classList.contains('error-message')) {
                    errorEl = document.createElement('div');
                    errorEl.classList.add('error-message');
                    field.parentNode.insertBefore(errorEl, field.nextSibling);
                }
                errorEl.textContent = `Please fill in ${field.previousElementSibling.textContent}`;
                
                return false;
            } else {
                // Remove error state if previously marked
                field.classList.remove('error');
                const errorEl = field.nextElementSibling;
                if (errorEl && errorEl.classList.contains('error-message')) {
                    errorEl.remove();
                }
            }
        }
        return true;
    }

    // Centralized data fetching function
    function fetchDropdownData() {
        // Fetch customer names
        google.script.run.withSuccessHandler(function(customers) {
            const select = document.getElementById('customer-name');
            select.innerHTML = '<option value="">Select Customer</option>' + 
                customers
                    .filter(customer => customer)
                    .map(customer => `<option value="${customer}">${customer}</option>`)
                    .join('');
        }).getCustomerNames();

        // Fetch grades
        google.script.run.withSuccessHandler(function(grades) {
            const gradeTemplate = ['<option value="">Grade</option>']
                .concat(grades.filter(grade => grade))
                .map(grade => `<option value="${grade}">${grade}</option>`)
                .join('');
            
            document.querySelectorAll('select[name="grade[]"]').forEach(select => {
                select.innerHTML = gradeTemplate;
            });
        }).getGrades();
    }
function getNextWorkOrderNumber() {
    // Call Google Apps Script to fetch the next Work Order Number
    google.script.run.withSuccessHandler(function(nextWorkOrderNumber) {
        document.getElementById('work-order-number').value = nextWorkOrderNumber;
    }).fetchNextWorkOrderNumber(); // Backend function to fetch the number
}

    // Enhanced row management
    function setupRowManagement() {
        const table = document.getElementById('data-table');
        const tbody = table.querySelector('tbody');

        // Add row functionality
        document.getElementById('add-row-btn').addEventListener('click', function() {
            // Hide remove buttons on existing rows
            tbody.querySelectorAll('.remove-row').forEach(btn => btn.style.display = 'none');
            
            // Clone last row and reset
            const newRow = tbody.lastElementChild.cloneNode(true);
            newRow.querySelectorAll('input, select').forEach(input => input.value = '');
            
            // Show remove button in new row
            const removeBtn = newRow.querySelector('.remove-row');
            removeBtn.style.display = 'block';
            
            tbody.appendChild(newRow);
        });

        // Remove row functionality with enhanced safety
        table.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-row')) {
                const rows = tbody.children;
                if (rows.length > 1) {
                    e.target.closest('tr').remove();
                    
                    // Ensure last row has remove button visible
                    if (rows.length > 0) {
                        rows[rows.length - 1].querySelector('.remove-row').style.display = 'block';
                    }
                } else {
                    alert('At least one row is required');
                }
            }
        });

        // Initial setup - hide first row's remove button
        tbody.firstElementChild.querySelector('.remove-row').style.display = 'none';
    }

    // Form submission handler
    function setupFormSubmission() {
        const form = document.getElementById('work-order-form');
        const loadingOverlay = document.getElementById('loading-overlay');
        const submitBtn = document.getElementById('submit-btn');

        form.addEventListener('submit', function(e) {
            e.preventDefault();

            // Comprehensive validation
            if (!validateForm(form)) return;

            // Disable submit and show loading
            submitBtn.disabled = true;
            loadingOverlay.style.display = 'flex';

            // Collect form data
            const formDataArray = Array.from(document.querySelectorAll('#data-table tbody tr'))
                .map(row => [
                    document.getElementById('customer-name').value,
                    document.getElementById('issue-date').value,
                    document.getElementById('delivery-date').value,
                    document.getElementById('remarks').value,
                    row.querySelector('input[name="size[]"]').value,
                    row.querySelector('input[name="tolerance[]"]').value,
                    row.querySelector('select[name="grade[]"]').value,
                    row.querySelector('input[name="quantity[]"]').value,
                    row.querySelector('input[name="rate[]"]').value,
                    row.querySelector('select[name="hb_hhb[]"]').value
                ]);

            // Submit to Google Sheets
            google.script.run
                .withSuccessHandler(handleSubmissionSuccess)
                .withFailureHandler(handleSubmissionError)
                .submitFormData(formDataArray);
        });
    }

    // Success handler
function handleSubmissionSuccess(response) {
    const loadingOverlay = document.getElementById('loading-overlay');
    const submitBtn = document.getElementById('submit-btn');
    const popup = document.getElementById('success-popup');
    const successMessage = document.getElementById('success-message');
    const workOrderNumber = document.getElementById('work-order-number').value;

    loadingOverlay.style.display = 'none';
    submitBtn.disabled = false;

    if (response === "Success") {
        // Update popup message with the Work Order Number
        successMessage.textContent = `Work order for Order ID - "${workOrderNumber}" has been submitted.`;

        popup.classList.add('show');

        // Reset form
        document.getElementById('work-order-form').reset();
        
        // Reset table to a single row
        const tbody = document.querySelector('#data-table tbody');
        const firstRow = tbody.firstElementChild.cloneNode(true);
        firstRow.querySelectorAll('input, select').forEach(input => input.value = '');
        tbody.innerHTML = '';
        tbody.appendChild(firstRow);

        // Auto-fetch the next Work Order Number
        getNextWorkOrderNumber();

        // Reload data if possible
        if (typeof loadData === 'function') loadData();

        // Auto-close popup
        setTimeout(closeSuccessPopup, 3000);
    }
}

    // Error handler
    function handleSubmissionError(error) {
        const loadingOverlay = document.getElementById('loading-overlay');
        const submitBtn = document.getElementById('submit-btn');

        loadingOverlay.style.display = 'none';
        submitBtn.disabled = false;
        
        // Enhanced error handling
        console.error('Submission Error:', error);
        alert(`Submission failed. ${error.message || 'Please try again.'}`);
    }

    // Popup close function
    function closeSuccessPopup() {
        const popup = document.getElementById('success-popup');
        popup.classList.remove('show');
    }
    function fetchWorkOrderNumber() {
    google.script.run.withSuccessHandler(function(orderNumber) {
        document.getElementById('work-order-number').value = orderNumber;
    }).getNextWorkOrderNumber();
}
    // Initialize on DOM load
document.addEventListener('DOMContentLoaded', function() {
    fetchDropdownData();
    setupRowManagement();
    setupFormSubmission();
    getNextWorkOrderNumber(); // Fetch and display the initial Work Order Number
});

</script> <!-- Create Work Order content -->
</div>

<div id="StatusUpdate" class="section">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
  <div class="header">
    <img src="https://mahajangroup.com/wp-content/uploads/2015/09/logo.png" alt="Company Logo"> <!-- Use a direct image link -->
    <h1>Update Status of Pending Work Orders</h1>
   
  </div>
 <div class="filters">
  <div>
    <label for="orderId">Order ID:</label>
    <input type="text" id="orderId" onkeyup="filterTable()">
  </div>
  <div>
    <label for="customerName">Customer Name:</label>
    <input type="text" id="customerName" onkeyup="filterTable()">
  </div>
  <!-- New refresh button -->
  <div>
    <i id = "eyebutton" class="fas fa-sync refresh-icon" onclick="refreshData()" title="Refresh Data"></i>
  </div>
</div>
  <table id="dataTable">
  <thead>
    <tr>
      <th>Order ID</th>
      <th>Customer ID</th>
      <th>Customer Name</th>
      <th>Issue Date</th>
      <th>Delivery Date</th>
      <th>Order Received On</th>
      <th>View Order Details</th>
    </tr>
  </thead>
  <tbody>
    <!-- Data rows will be inserted here by the script -->
  </tbody>
</table>


  <!-- Modal for Order Details -->
<!-- Modal for Order Details -->
<div id="orderModal" class="modal">
  <div class="order-details">
    <div class="modal-header">
      <img src="https://mahajangroup.com/wp-content/uploads/2015/09/logo.png" alt="Company Logo">
      <h2 id="modalTitle">Order Details</h2>
      <span class="close" onclick="closeModal()">&times;</span>
    </div>
    <div id="modalBody" class="order-details"></div>
    <!-- Add Submit All button -->
    <div class="submit-all-section" style="text-align: center; margin: 15px 0;">
      <button id = "button" onclick="submitAllUpdates()" style= "background-color: #E50914; color: white; padding: 10px 20px; border: none; border-radius: 25px; cursor: pointer; font-family : Poppins"> 
        Submit All Updates
      </button>
    </div>
  </div>
</div>


<script>
    // Debounce function to limit frequent filter calls
    function debounce(func, delay) {
        let timeoutId;
        return function() {
            const context = this;
            const args = arguments;
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => func.apply(context, args), delay);
        };
    }

    function loadData() {
        google.script.run.withSuccessHandler(fillTable).getData();
    }

    function fillTable(data) {
        const uniqueOrders = new Map();
        const table = document.getElementById('dataTable').getElementsByTagName('tbody')[0];
        table.innerHTML = ''; 

        data.forEach(row => {
            const orderId = row[0];
            const status = row[14] || ''; 
            
            if (status !== 'Close') {
                if (!uniqueOrders.has(orderId)) {
                    uniqueOrders.set(orderId, []);
                }
                uniqueOrders.get(orderId).push(row);
            }
        });

        // Check if header row is already present (prevent duplication)
        const existingHeaderRow = table.parentElement.querySelector('thead');
        if (!existingHeaderRow) {
            const headerRow = table.insertRow(0);
            ['Order ID', 'Customer ID', 'Customer Name', 'Issue Date', 'Delivery Date', 'Order Received On', 'Actions']
                .forEach((heading) => {
                    const headerCell = document.createElement('th');
                    headerCell.textContent = heading;
                    headerRow.appendChild(headerCell);
                });
        }

        uniqueOrders.forEach((orderDetails, orderId) => {
            const rowData = orderDetails[0];
            if (rowData) {
                const newRow = table.insertRow();
                newRow.setAttribute('data-rowid', rowData[13]);

                const columnsToDisplay = [0, 1, 2, 8, 9, 11];
                columnsToDisplay.forEach(index => {
                    const cellValue = rowData[index];
                    const newCell = newRow.insertCell();
                    newCell.textContent = cellValue || '';
                });

                const actionsCell = newRow.insertCell();
                const infoIcon = document.createElement('i');
                infoIcon.className = "fa-solid fa-eye";
                infoIcon.style.cursor = 'pointer';
                infoIcon.onclick = () => showOrderDetails(orderDetails, orderId);
                actionsCell.appendChild(infoIcon);
            }
        });
    }

    // Optimized filter with debounce
    const filterTable = debounce(function() {
        const orderIdFilter = document.getElementById('orderId').value.toLowerCase();
        const customerNameFilter = document.getElementById('customerName').value.toLowerCase();
        const table = document.getElementById('dataTable');
        const rows = table.getElementsByTagName('tr');

        for (let i = 1; i < rows.length; i++) {
            const cells = rows[i].getElementsByTagName('td');
            const orderId = cells[0].textContent.toLowerCase();
            const customerName = cells[2].textContent.toLowerCase();

            rows[i].style.display = (
                orderId.includes(orderIdFilter) && 
                customerName.includes(customerNameFilter)
            ) ? '' : 'none';
        }
    }, 300);  // 300ms debounce delay

    function refreshData() {
        const refreshIcon = document.querySelector('.refresh-icon');
        refreshIcon.classList.add('fa-spin');

        const table = document.getElementById('dataTable').getElementsByTagName('tbody')[0];
        table.innerHTML = '';

        google.script.run.withSuccessHandler(function(data) {
            refreshIcon.classList.remove('fa-spin');
            fillTable(data);

            const successPopup = document.createElement('div');
            successPopup.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #4CAF50; color: white; padding: 20px; border-radius: 10px; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    Data refreshed successfully!
                </div>
            `;
            document.body.appendChild(successPopup);

            setTimeout(() => {
                document.body.removeChild(successPopup);
            }, 2000);
        }).withFailureHandler(function(error) {
            refreshIcon.classList.remove('fa-spin');

            const errorPopup = document.createElement('div');
            errorPopup.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #f44336; color: white; padding: 20px; border-radius: 10px; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    There are currently no outstanding work orders.
                </div>
            `;
            document.body.appendChild(errorPopup);

            setTimeout(() => {
                document.body.removeChild(errorPopup);
            }, 2000);

            console.error('Data refresh error:', error);
        }).getData();
    }
  function submitAllUpdates() {
      const modalBody = document.getElementById('modalBody');
      const rows = modalBody.querySelectorAll('tbody tr');
      const updatesToSubmit = [];

      // Create a loading spinner
      const loadingSpinner = document.createElement('div');
      loadingSpinner.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;">
          <div style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #E50914; border-radius: 50%; animation: spin 1s linear infinite;">
          </div>
        </div>
        <style>
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
        </style>
      `;
      document.body.appendChild(loadingSpinner);

      rows.forEach(row => {
        const qtyInput = row.querySelector('.qty-input');
        const statusSelect = row.querySelector('.status-select');
        const rowId = qtyInput.getAttribute('data-rowid');
        const qty = qtyInput.value;
        const status = statusSelect.value;

        if (qty && status) {
          updatesToSubmit.push({
            rowId: rowId,
            qty: qty,
            status: status
          });
        }
      });

      if (updatesToSubmit.length > 0) {
        // Call a new Google Script function to update multiple rows
        google.script.run.withSuccessHandler(function(result) {
          // Remove loading spinner
          document.body.removeChild(loadingSpinner);

          // Close the modal immediately after submission
          closeModal();

          // Reload the data to remove closed rows
          loadData();

          // Create a success popup
          const successPopup = document.createElement('div');
          successPopup.innerHTML = `
            <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #4CAF50; color: white; padding: 20px; border-radius: 10px; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
              Successfully updated ${updatesToSubmit.length} row(s)!
            </div>
          `;
          document.body.appendChild(successPopup);

          // Remove popup after 3 seconds
          setTimeout(() => {
            document.body.removeChild(successPopup);
          }, 3000);
        }).updateMultipleOrderData(updatesToSubmit);
      } else {
        // Remove loading spinner if no updates
        if (document.body.contains(loadingSpinner)) {
          document.body.removeChild(loadingSpinner);
        }
        alert("No updates to submit. Please enter Quantity and Status for at least one row.");
      }
    }

  function showOrderDetails(orderDetails, orderId) {
  const modalTitle = document.getElementById('modalTitle');
  const modalBody = document.getElementById('modalBody');
  
  // Filter out rows with 'Close' status
  const activeOrderDetails = orderDetails.filter(detail => detail[14] !== 'Close');
  
  // Use the first row for header information
  const headerInfo = activeOrderDetails[0];
  
  // Create a header section with key order details
  const headerHTML = `
    <div class="order-header">
      <div class="header-details">
        <p><strong>Customer ID:</strong> ${headerInfo[1]}</p>
        <p><strong>Customer Name:</strong> ${headerInfo[2]}</p>
        <p><strong>Issue Date:</strong> ${headerInfo[8]}</p>
        <p><strong>Delivery Date:</strong> ${headerInfo[9]}</p>
        <p><strong>Order Received Date:</strong> ${headerInfo[11]}</p>
        <p><strong>Remarks:</strong> ${headerInfo[10]}</p>
      </div>
    </div>
  `;
  
  modalBody.innerHTML = `
    ${headerHTML}
    <table>
      <thead>
        <tr>
          <th>Size</th>
          <th>Tolerance</th>
          <th>Grade</th>
          <th>Quantity (MT)</th>
          <th>Rate</th>
          <th>Hb/HHb</th>
          <th>QTY</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        ${activeOrderDetails.map(detail => {
          const originalQuantity = parseFloat(detail[6]);
          return `
          <tr>
            <td>${detail[3]}</td>
            <td>${detail[4]}</td>
            <td>${detail[5]}</td>
            <td>${detail[6]}</td>
            <td>${detail[12]}</td>
            <td>${detail[7]}</td>
            <td>
              <input type="number" class="qty-input" value="" placeholder="QTY"
                     data-rowid="${detail[13]}"
                     data-original-qty="${originalQuantity}"
                     oninput="handleQtyInput(this)" />
            </td>
            <td>
              <select class="status-select"
                      data-rowid="${detail[13]}"
                      disabled>
                <option value="Open">Open</option>
                <option value="Close">Close</option>
              </select>
            </td>
          </tr>
        `}).join('')}
      </tbody>
    </table>
  `;
  
  // Set the modal title
  modalTitle.textContent = `Order Details for Order ID: ${orderId}`;
  
  // Show the modal
  document.getElementById('orderModal').style.display = 'block';
}
function handleQtyInput(inputElement) {
  const rowId = inputElement.getAttribute('data-rowid');
  const originalQty = parseFloat(inputElement.getAttribute('data-original-qty'));
  const enteredQty = parseFloat(inputElement.value) || 0;
  
  const statusSelect = document.querySelector(`.status-select[data-rowid="${rowId}"]`);
  
  if (enteredQty > 0) {
    statusSelect.disabled = false;
    
    if (enteredQty >= originalQty) {
      // If entered quantity is equal to or more than original quantity
      statusSelect.value = 'Close';
      statusSelect.disabled = false;
    } else if (enteredQty < originalQty) {
      // If entered quantity is less than original quantity
      statusSelect.value = 'Open';
      statusSelect.disabled = false;
      statusSelect.style.color = 'black';
    }
  } else {
    // If no quantity is entered
    statusSelect.disabled = true;
    statusSelect.style.backgroundColor = '';
    statusSelect.style.color = '';
  }
}
// This function will show the input fields and the submit button when the user clicks "Edit"
function editOrder(rowId) {
  selectedRowId = rowId; // Store the selected row's ID
  document.getElementById('inputFields').style.display = 'block'; // Show the input fields
}

// Submit the updated data to the sheet and update the table
function submitUpdate() {
  const qty = document.getElementById('qtyInput').value;
  const status = document.getElementById('statusInput').value;

  if (qty && status) {
    // Update the data in Google Sheets (columns N and O for QTY and Status)
    google.script.run.withSuccessHandler(function() {
      alert("Data updated successfully!");
      updateTableData(selectedRowId, qty, status); // Update the table with the new values
      closeModal(); // Close the modal after submitting
    }).updateOrderData(selectedRowId, qty, status);
  } else {
    alert("Please enter both Quantity and Status.");
  }
}

// Function to update the table after successful submission
function updateTableData(rowId, qty, status) {
  const table = document.getElementById('dataTable');
  const rows = table.getElementsByTagName('tr');

  for (let i = 1; i < rows.length; i++) {
    const cells = rows[i].getElementsByTagName('td');
    const rowCellId = cells[11].textContent; // Assuming row ID is in the 12th column (index 11)

    if (rowCellId === rowId) {
      cells[13].textContent = qty;  // Update column N (QTY)
      cells[14].textContent = status;  // Update column O (Status)
      break;
    }
  }
}
    function closeModal() {
      document.getElementById('orderModal').style.display = 'none';
    }
    // Keep all your existing functions like submitAllUpdates, showOrderDetails, handleQtyInput, etc.
    // ... (paste the rest of your original script functions here)

    // Bind filter inputs to debounced function
    document.getElementById('orderId').addEventListener('keyup', filterTable);
    document.getElementById('customerName').addEventListener('keyup', filterTable);

    window.onload = function() {
        refreshData();    
    };
</script>
</div>

<div id="MASTER" class="section">
    <div class="header">
    <img src="https://mahajangroup.com/wp-content/uploads/2015/09/logo.png" alt="Company Logo"> <!-- Use a direct image link -->
    <h1>Work Order Management Dashboard</h1>  
  </div>
 <div class="filters">
        <div class="filter">
                <label for="search-order-identifier">Order ID:</label>
                <input type="text" id="search-order-identifier">
            </div>
            <div class="filter-input">
                <label for="search-customer-name">Customer Name:</label>
                <input type="text" id="search-customer-name">
            </div>
            <div class="action-icons">
                <i id="data-refresh-control" class="fas fa-sync refresh-icon" title="Refresh Data"></i>
            </div>
     
        <div class="filter-input">
            <label for="order-status-selector">Status:</label>
            <select id="order-status-selector">
                <option value="All">All</option>
                <option value="Open">Open</option>
                <option value="Close">Close</option>
            </select>
        </div>
           </div>
        <table id="order-data-grid">
            <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Customer ID</th>
                    <th>Customer Name</th>
                    <th>Issue Date</th>
                    <th>Delivery Date</th>
                    <th>Order Received On</th>
                    <th>View Order Details</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data rows will be dynamically populated -->
            </tbody>
        </table>

        <div id="order-details-overlay" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="order-details-title">Order Details</h2>
                    <span class="close" onclick="closeOrderDetailsModal()">&times;</span>
                </div>
                <div id="order-details-container" class="order-details"></div>
            </div>
        </div>

    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <script>
    let GLOBAL_ORDER_COLLECTION = []; 

    function initializeOrderData() {
        google.script.run.withSuccessHandler(function(data) {
            GLOBAL_ORDER_COLLECTION = data;
            populateOrderGrid(GLOBAL_ORDER_COLLECTION);
        }).getmasterData();
    }

    function populateOrderGrid(data) {
        const orderGrid = document.getElementById('order-data-grid').getElementsByTagName('tbody')[0];
        orderGrid.innerHTML = ''; 

        const statusSelector = document.getElementById('order-status-selector').value;

        const filteredData = data.filter(row => {
            const status = (row[14] || '').trim().toLowerCase();
            
            return statusSelector === 'All' || 
                   (statusSelector.toLowerCase() === 'open' && status === 'open') ||
                   (statusSelector.toLowerCase() === 'close' && status === 'close');
        });

        const uniqueOrders = {};
        filteredData.forEach(row => {
            const orderId = row[0];
            if (!uniqueOrders[orderId]) {
                uniqueOrders[orderId] = [row];
            } else {
                uniqueOrders[orderId].push(row);
            }
        });

        Object.keys(uniqueOrders).forEach(orderId => {
            const orderRows = uniqueOrders[orderId];
            const rowData = orderRows[0]; 
            
            const newRow = orderGrid.insertRow(); 
            
            const columnsToDisplay = [0, 1, 2, 8, 9, 11];
            columnsToDisplay.forEach(index => {
                const newCell = newRow.insertCell();
                newCell.textContent = rowData[index] || '';
            });

            const actionsCell = newRow.insertCell();
            const detailsIcon = document.createElement('i');
            detailsIcon.className = "fa-solid fa-eye";
            detailsIcon.style.cursor = 'pointer';
            detailsIcon.onclick = () => displayOrderDetails(orderRows, rowData[0]);
            actionsCell.appendChild(detailsIcon);
        });

        if (Object.keys(uniqueOrders).length === 0) {
            const noDataRow = orderGrid.insertRow();
            const noDataCell = noDataRow.insertCell();
            noDataCell.colSpan = 7;
            noDataCell.textContent = 'No orders found matching the selected status.';
            noDataCell.style.textAlign = 'center';
            noDataCell.style.color = 'red';
        }
    }

    function debounceFunction(func, delay) {
        let debounceTimer;
        return function() {
            const context = this;
            const args = arguments;
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => func.apply(context, args), delay);
        }
    }

    const filterOrders = debounceFunction(function() {
        if (!GLOBAL_ORDER_COLLECTION.length) return;

        const orderIdentifierFilter = document.getElementById('search-order-identifier').value.toLowerCase().trim();
        const customerNameFilter = document.getElementById('search-customer-name').value.toLowerCase().trim();
        const statusSelector = document.getElementById('order-status-selector').value;

        const filteredData = GLOBAL_ORDER_COLLECTION.filter(row => {
            const status = (row[14] || '').trim().toLowerCase();
            const statusMatch = statusSelector === 'All' || 
                                (statusSelector.toLowerCase() === 'open' && status === 'open') ||
                                (statusSelector.toLowerCase() === 'close' && status === 'close');

            const orderIdentifierMatch = !orderIdentifierFilter || 
                                 row[0].toLowerCase().includes(orderIdentifierFilter);

            const customerNameMatch = !customerNameFilter || 
                                      row[2].toLowerCase().includes(customerNameFilter);

            return statusMatch && orderIdentifierMatch && customerNameMatch;
        });

        populateOrderGrid(filteredData);
    }, 300);

    function displayOrderDetails(orderDetails, orderId) {
        const modalTitle = document.getElementById('order-details-title');
        const modalContainer = document.getElementById('order-details-container');

        const activeOrderDetails = orderDetails.filter(detail => detail[14] && detail[14].trim() !== '');  
        const statusSelector = document.getElementById('order-status-selector').value.toLowerCase();

        const filteredOrderDetails = activeOrderDetails.filter(detail => {
            const status = detail[14].trim().toLowerCase();
            return statusSelector === 'all' || status === statusSelector;
        });

        const headerInfo = filteredOrderDetails[0];

        const headerHTML = `
            <div class="order-details-header">
                <div class="header-details">
                    <p><strong>Customer ID:</strong> ${headerInfo[1]}</p>
                    <p><strong>Customer Name:</strong> ${headerInfo[2]}</p>
                    <p><strong>Issue Date:</strong> ${headerInfo[8]}</p>
                    <p><strong>Delivery Date:</strong> ${headerInfo[9]}</p>
                    <p><strong>Order Received Date:</strong> ${headerInfo[11]}</p>
                    <p><strong>Remarks:</strong> ${headerInfo[10]}</p>
                </div>
            </div>
        `;

        modalContainer.innerHTML = `
            ${headerHTML}
            <table>
                <thead>
                    <tr>
                        <th>Size</th>
                        <th>Tolerance</th>
                        <th>Grade</th>
                        <th>Quantity Requested</th>
                        <th>Rate</th>
                        <th>Hb/HHb</th>
                        <th>Status</th>
                        <th>Quantity Dispatched</th>
                        <th>Remaining Quantity</th>
                    </tr>
                </thead>
                <tbody>
                    ${filteredOrderDetails.map(detail => {
                        return `
                        <tr>
                            <td>${detail[3]}</td>
                            <td>${detail[4]}</td>
                            <td>${detail[5]}</td>
                            <td>${detail[6]}</td>
                            <td>${detail[15]}</td>
                            <td>${detail[7]}</td>
                            <td>${detail[14]}</td>
                            <td>${detail[13]}</td>
                            <td>${detail[16]}</td>
                        </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;
        
        modalTitle.textContent = `Order Details for Order ID: ${orderId}`;
        document.getElementById('order-details-overlay').style.display = 'block';
    }

    function closeOrderDetailsModal() {
        document.getElementById('order-details-overlay').style.display = 'none';
    }

    function refreshOrderData() {
        const refreshIcon = document.querySelector('.refresh-icon');
        refreshIcon.classList.add('fa-spin');

        google.script.run
            .withSuccessHandler(function(data) {
                GLOBAL_ORDER_COLLECTION = data;
                populateOrderGrid(GLOBAL_ORDER_COLLECTION);

                refreshIcon.classList.remove('fa-spin');

                const successPopup = document.createElement('div');
                successPopup.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #4CAF50; color: white; padding: 20px; border-radius: 10px; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    Data refreshed successfully!
                </div>
                `;
                document.body.appendChild(successPopup);

                setTimeout(() => {
                    document.body.removeChild(successPopup);
                }, 2000);
            })
            .withFailureHandler(function(error) {
                refreshIcon.classList.remove('fa-spin');

                const errorPopup = document.createElement('div');
                errorPopup.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #f44336; color: white; padding: 20px; border-radius: 10px; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    Failed to refresh data. Please try again.
                </div>
                `;
                document.body.appendChild(errorPopup);

                setTimeout(() => {
                    document.body.removeChild(errorPopup);
                }, 2000);

                console.error('Data refresh error:', error);
            })
            .getmasterData();
    }

    // Event Listeners
    document.getElementById('search-order-identifier').addEventListener('input', filterOrders);
    document.getElementById('search-customer-name').addEventListener('input', filterOrders);
    document.getElementById('order-status-selector').addEventListener('change', filterOrders);
    document.getElementById('data-refresh-control').addEventListener('click', refreshOrderData);

    // Initial data load
    document.addEventListener('DOMContentLoaded', initializeOrderData);
    </script> <!-- Order Management content -->
</div>


<div id = "for-print-mgt-container" class="section">
        <div class="header">
    <img src="https://mahajangroup.com/wp-content/uploads/2015/09/logo.png" alt="Company Logo"> <!-- Use a direct image link -->
    <h1>Print Work Order for Management</h1>
   
  </div>
 <div class="filters">

            <div class="for-print-mgt-filter-group">
                <label for="for-print-mgt-order-id">Order ID:</label>
                <input type="text" id="for-print-mgt-order-id" class="for-print-mgt-filter-input">
            </div>
            <div class="for-print-mgt-filter-group">
                <label for="for-print-mgt-customer-name">Customer Name:</label>
                <input type="text" id="for-print-mgt-customer-name" class="for-print-mgt-filter-input">
            </div>
            <div class="for-print-mgt-filter-group">
                <label for="for-print-mgt-status">Status:</label>
                <select id="for-print-mgt-status" class="for-print-mgt-filter-input">
                    <option value="All">All</option>
                    <option value="Open">Open</option>
                    <option value="Close">Close</option>
                </select>
            </div>
        <div class="for-print-mgt-actions">
            <i id="for-print-mgt-refresh" class="fas fa-sync for-print-mgt-refresh-icon" title="Refresh Data"></i>
            <i class="fas fa-print for-print-mgt-print-icon" onclick="printOrderTableMgt()" title="Print Orders"></i>
        </div>
        </div>
        <table id="for-print-mgt-table" class="for-print-mgt-table">
            <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Customer ID</th>
                    <th>Customer Name</th>
                    <th>Issue Date</th>
                    <th>Delivery Date</th>
                    <th>Order Received On</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data rows will be inserted here -->
            </tbody>
        </table>

        <div id="for-print-mgt-modal" class="modal">
            <div class="order-details">
                <div class="modal-header">
                    <h2 id="for-print-mgt-modal-title">Order Details</h2>
                    <span class="close" onclick="closeModalMgt()">&times;</span>
                </div>
                <div id="for-print-mgt-modal-body"></div>
            </div>
        
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <script>
        let GLOBAL_ORDER_DATA_MGT = [];

        function loadOrderDataMgt() {
            google.script.run.withSuccessHandler(function(data) {
                GLOBAL_ORDER_DATA_MGT = data;
                populateOrderTableMgt(GLOBAL_ORDER_DATA_MGT);
            }).getmasterData();
        }

        const filterOrdersMgt = _.debounce(function() {
            if (!GLOBAL_ORDER_DATA_MGT.length) return;

            const orderIdFilter = document.getElementById('for-print-mgt-order-id').value.toLowerCase().trim();
            const customerNameFilter = document.getElementById('for-print-mgt-customer-name').value.toLowerCase().trim();
            const statusFilter = document.getElementById('for-print-mgt-status').value;

            const filteredData = GLOBAL_ORDER_DATA_MGT.filter(row => {
                const status = (row[14] || '').trim().toLowerCase();
                const statusMatch = statusFilter === 'All' || 
                                  (statusFilter.toLowerCase() === 'open' && status === 'open') ||
                                  (statusFilter.toLowerCase() === 'close' && status === 'close');

                const orderIdMatch = !orderIdFilter || row[0].toLowerCase().includes(orderIdFilter);
                const customerNameMatch = !customerNameFilter || row[2].toLowerCase().includes(customerNameFilter);

                return statusMatch && orderIdMatch && customerNameMatch;
            });

            populateOrderTableMgt(filteredData);
        }, 300);

        function populateOrderTableMgt(data) {
            const tableBody = document.querySelector('#for-print-mgt-table tbody');
            tableBody.innerHTML = '';

            const uniqueOrders = {};
            data.forEach(row => {
                const orderId = row[0];
                if (!uniqueOrders[orderId]) {
                    uniqueOrders[orderId] = [row];
                } else {
                    uniqueOrders[orderId].push(row);
                }
            });

            Object.entries(uniqueOrders).forEach(([orderId, orderRows]) => {
                const row = orderRows[0];
                const tr = document.createElement('tr');
                
                [0, 1, 2, 8, 9, 11].forEach(index => {
                    const td = document.createElement('td');
                    td.textContent = row[index] || '';
                    tr.appendChild(td);
                });

                const actionsTd = document.createElement('td');
                const viewIcon = document.createElement('i');
                viewIcon.className = 'fa-solid fa-eye';
                viewIcon.style.cursor = 'pointer';
                viewIcon.onclick = () => showOrderDetailsMgt(orderRows, orderId);
                actionsTd.appendChild(viewIcon);
                tr.appendChild(actionsTd);

                tableBody.appendChild(tr);
            });
        }

    function showOrderDetailsMgt(orderDetails, orderId) {
    const modalTitle = document.getElementById('for-print-mgt-modal-title');
    const modalBody = document.getElementById('for-print-mgt-modal-body');

    // Filter order details to ensure only valid entries
    const activeOrderDetails = orderDetails.filter(detail => detail[14] && detail[14].trim() !== '');
    const statusSelector = document.getElementById('order-status-selector').value.toLowerCase();

    const filteredOrderDetails = activeOrderDetails.filter(detail => {
        const status = detail[14].trim().toLowerCase();
        return statusSelector === 'all' || status === statusSelector;
    });

    // Get header information from the filtered data
    const headerInfo = filteredOrderDetails[0] || {};

    // Create header section
    const headerHTML = `
        <div class="order-header">
            <p><strong>Customer ID:</strong> ${headerInfo[1] || 'N/A'}</p>
            <p><strong>Customer Name:</strong> ${headerInfo[2] || 'N/A'}</p>
            <p><strong>Issue Date:</strong> ${headerInfo[8] || 'N/A'}</p>
            <p><strong>Delivery Date:</strong> ${headerInfo[9] || 'N/A'}</p>
            <p><strong>Order Received Date:</strong> ${headerInfo[11] || 'N/A'}</p>
            <p><strong>Remarks:</strong> ${headerInfo[10] || 'N/A'}</p>
        </div>
        
    `;

    // Create table body
    const tableHTML = `
        <table class="for-print-mgt-details-table"><i class="fas fa-print print-button" onclick="printModal()" title="Print Order Details"></i> 
            <thead>
                <tr>
                    <th>Size</th>
                    <th>Tolerance</th>
                    <th>Grade</th>
                    <th>Quantity Requested</th>
                    <th>Rate</th>
                    <th>Hb/HHb</th>
                    <th>Status</th>
                    <th>Quantity Dispatched</th>
                    <th>Remaining Quantity</th>
                </tr>
            </thead>
            <tbody>
                ${filteredOrderDetails.map(detail => `
                    <tr>
                        <td>${detail[3] || 'N/A'}</td>
                        <td>${detail[4] || 'N/A'}</td>
                        <td>${detail[5] || 'N/A'}</td>
                        <td>${detail[6] || 'N/A'}</td>
                        <td>${detail[15] || 'N/A'}</td>
                        <td>${detail[7] || 'N/A'}</td>
                        <td>${detail[14] || 'N/A'}</td>
                        <td>${detail[13] || 'N/A'}</td>
                        <td>${detail[16] || 'N/A'}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;

    // Populate modal content
    modalTitle.textContent = `Order Details - ${orderId}`;
    modalBody.innerHTML = `${headerHTML}${tableHTML}`;

    // Display modal
    document.getElementById('for-print-mgt-modal').style.display = 'block';
}


        function closeModalMgt() {
            document.getElementById('for-print-mgt-modal').style.display = 'none';
        }

        function printOrderTableMgt() {
            const printWindow = window.open('', '', 'width=800,height=600');
            const table = document.getElementById('for-print-mgt-table').cloneNode(true);
            
            // Remove actions column
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                if (row.cells.length > 6) {
                    row.deleteCell(-1);
                }
            });

            printWindow.document.write(`
                <html>
                    <head>
                        <title>Print Orders</title>
                        <style>
                            table { width: 100%; border-collapse: collapse; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; }
                        </style>
                    </head>
                    <body>
                        ${table.outerHTML}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Event Listeners
        document.getElementById('for-print-mgt-order-id').addEventListener('input', filterOrdersMgt);
        document.getElementById('for-print-mgt-customer-name').addEventListener('input', filterOrdersMgt);
        document.getElementById('for-print-mgt-status').addEventListener('change', filterOrdersMgt);
        document.getElementById('for-print-mgt-refresh').addEventListener('click', loadOrderDataMgt);

        // Initial load
        document.addEventListener('DOMContentLoaded', loadOrderDataMgt);
function printModal() {
    const tableContent = document.querySelector('.for-print-mgt-details-table').outerHTML;
    const headerContent = document.querySelector('.order-header').outerHTML;

    const printWindow = window.open('', '', 'width=800,height=600');
    printWindow.document.write('<html><head><title>Print Order Details</title></head><body>');
    printWindow.document.write(headerContent); // Add the header
    printWindow.document.write(tableContent); // Add the table
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.print();
}

    </script>
    </div>
</div>

<div id="print-work-order" class="section">
<div class="header">
        <img src="/api/placeholder/120/40" alt="Company Logo">
        <h2>Print Work Order for Plant</h2>
    </div>

    <div class="filters">
        <div class="print-work-filter-group">
            <label>Order ID:</label>
            <input type="text" id="print-work-order-id">
        </div>
        <div class="print-work-filter-group">
            <label>Customer Name:</label>
            <input type="text" id="print-work-customer-name">
        </div>
        <div class="print-work-filter-group">
            <label>Status:</label>
            <select id="print-work-status">
                <option value="All">All</option>
                <option value="Open">Open</option>
                <option value="Close">Close</option>
            </select>
        </div>
        <div class="print-work-actions">
            <i class="fas fa-sync" id="print-work-refresh" title="Refresh Data"></i>
            <i class="fas fa-print" onclick="printWorkOrders()" title="Print Orders"></i>
        </div>
    </div>

    <div class="print-work-table-container">
        <table class="print-work-table">
            <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Customer ID</th>
                    <th>Customer Name</th>
                    <th>Issue Date</th>
                    <th>Delivery Date</th>
                    <th>Order Received On</th>
                    <th class="no-print">Actions</th>
                </tr>
            </thead>
            <tbody id="print-work-table-body">
            </tbody>
        </table>
    </div>

    <div id="print-work-modal" class="modal">
        <div class="order-details">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <h3 id="print-work-modal-title">Order Details</h3>
                <span style="cursor: pointer;" onclick="closeWorkModal()">&times;</span>
            </div>
            <div id="print-work-modal-body"></div>
        </div>
    </div>

    <script>
        let WORK_ORDER_DATA = [];

        function loadWorkOrderData() {
            google.script.run.withSuccessHandler(function(data) {
                WORK_ORDER_DATA = data;
                populateWorkOrderTable(WORK_ORDER_DATA);
            }).getmasterData();
        }

        function populateWorkOrderTable(data) {
            const tableBody = document.getElementById('print-work-table-body');
            tableBody.innerHTML = '';

            const uniqueOrders = {};
            data.forEach(row => {
                if (!uniqueOrders[row[0]]) uniqueOrders[row[0]] = [row];
                else uniqueOrders[row[0]].push(row);
            });

            Object.entries(uniqueOrders).forEach(([orderId, rows]) => {
                const row = rows[0];
                const tr = document.createElement('tr');
                
                [0,1,2,8,9,11].forEach(index => {
                    const td = document.createElement('td');
                    td.textContent = row[index] || '';
                    tr.appendChild(td);
                });

                const actionsTd = document.createElement('td');
                actionsTd.className = 'no-print';
                const viewIcon = document.createElement('i');
                viewIcon.className = 'fas fa-eye';
                viewIcon.style.cursor = 'pointer';
                viewIcon.onclick = () => showWorkOrderDetails(rows, orderId);
                actionsTd.appendChild(viewIcon);
                tr.appendChild(actionsTd);

                tableBody.appendChild(tr);
            });
        }

        function filterWorkOrders() {
            const orderId = document.getElementById('print-work-order-id').value.toLowerCase();
            const customerName = document.getElementById('print-work-customer-name').value.toLowerCase();
            const status = document.getElementById('print-work-status').value;

            const filteredData = WORK_ORDER_DATA.filter(row => {
                const rowStatus = (row[14] || '').trim().toLowerCase();
                return (status === 'All' || rowStatus === status.toLowerCase()) &&
                       (!orderId || row[0].toLowerCase().includes(orderId)) &&
                       (!customerName || row[2].toLowerCase().includes(customerName));
            });

            populateWorkOrderTable(filteredData);
        }

        function showWorkOrderDetails(details, orderId) {
            const modalBody = document.getElementById('print-work-modal-body');
            const headerInfo = details[0] || {};

            const headerHTML = `
                <div class="order-header">
                    <p><strong>Issue Date:</strong> ${headerInfo[8] || 'N/A'}</p>
                    <p><strong>Delivery Date:</strong> ${headerInfo[9] || 'N/A'}</p>
                    <p><strong>Order Received Date:</strong> ${headerInfo[11] || 'N/A'}</p>
                    <p><strong>Remarks:</strong> ${headerInfo[10] || 'N/A'}</p>
                </div>
            `;

            const tableHTML = `
                <table class="print-work-table">
                    <thead>
                        <tr>
                            <th>Size</th>
                            <th>Tolerance</th>
                            <th>Grade</th>
                            <th>Quantity Requested</th>
                            
                            <th>Hb/HHb</th>
                            <th>Status</th>
                            <th>Quantity Dispatched</th>
                            <th>Remaining Quantity</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${details.map(detail => `
                            <tr>
                                <td>${detail[3] || 'N/A'}</td>
                                <td>${detail[4] || 'N/A'}</td>
                                <td>${detail[5] || 'N/A'}</td>
                                <td>${detail[6] || 'N/A'}</td>
                               
                                <td>${detail[7] || 'N/A'}</td>
                                <td>${detail[14] || 'N/A'}</td>
                                <td>${detail[13] || 'N/A'}</td>
                                <td>${detail[16] || 'N/A'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <div style="margin-top: 20px;">
                    <i class="fas fa-print" onclick="printWorkModal()" style="cursor: pointer;" title="Print Details"></i>
                </div>
            `;

            modalBody.innerHTML = headerHTML + tableHTML;
            document.getElementById('print-work-modal-title').textContent = `Order Details - ${orderId}`;
            document.getElementById('print-work-modal').style.display = 'block';
        }

        function closeWorkModal() {
            document.getElementById('print-work-modal').style.display = 'none';
        }

        function printWorkOrders() {
            window.print();
        }

        function printWorkModal() {
            const content = document.getElementById('print-work-modal-body').innerHTML;
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(`
                <html>
                    <head>
                        <style>
                            body { font-family: Arial, sans-serif; }
                            table { width: 100%; border-collapse: collapse; }
                            th, td { border: 1px solid #ddd; padding: 8px; }
                            th { background: #f5f5f5; }
                        </style>
                    </head>
                    <body>${content}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Event Listeners
        document.getElementById('print-work-order-id').addEventListener('input', filterWorkOrders);
        document.getElementById('print-work-customer-name').addEventListener('input', filterWorkOrders);
        document.getElementById('print-work-status').addEventListener('change', filterWorkOrders);
        document.getElementById('print-work-refresh').addEventListener('click', loadWorkOrderData);

        // Initial load
        document.addEventListener('DOMContentLoaded', loadWorkOrderData);
    </script>
</div>

<div id="EDITABLE_DASHBOARD" class="section">
        <div class="header">
            <img src="https://mahajangroup.com/wp-content/uploads/2015/09/logo.png" alt="Company Logo">
            <h1>Work Order Management Dashboard (Editable)</h1>  
        </div>
        <div class="filters" role="region" aria-label="Filters">
            <div class="input-group">
                <label for="edit-order-id-search">Order ID:</label>
                <input type="text" id="edit-order-id-search" placeholder="Search by Order ID" aria-label="Search by Order ID">
            </div>
            <div class="input-group">
                <label for="edit-customer-name-search">Customer Name:</label>
                <input type="text" id="edit-customer-name-search" placeholder="Search by Customer Name" aria-label="Search by Customer Name">
            </div>
            <div class="input-group">
                <label for="edit-status-filter">Status:</label>
                <select id="edit-status-filter" aria-label="Order Status Selector">
                    <option value="All">All</option>
                    <option value="Open">Open</option>
                    <option value="Close">Close</option>
                </select>
            </div>
            <div class="control-icons">
                <i id="edit-refresh-data" class="fas fa-sync reload-icon" title="Refresh Data" aria-label="Refresh Data"></i>
            </div>
        </div>

        <table id="editable-orders-table" aria-label="Work Orders">
            <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Customer ID</th>
                    <th>Customer Name</th>
                    <th>Issue Date</th>
                    <th>Delivery Date</th>
                    <th>Order Received On</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data rows will be dynamically populated -->
            </tbody>
        </table>

        <div id="edit-order-info-popup" class="popup-modal" role="dialog" aria-modal="true" aria-labelledby="edit-order-info-title" aria-hidden="true">
            <div class="modal-body">
                <div class="modal-head">
                    <h2 id="edit-order-info-title">Order Details</h2>
                    <span class="close-btn" onclick="closeEditOrderInfoPopup()" aria-label="Close Modal">&times;</span>
                </div>
                <div id="edit-order-info-container" class="order-details">
                    <form id="edit-order-info-form" aria-label="Order Details Form">
                        <!-- Form will be dynamically populated -->
                    </form>
                </div>
                <div class="modal-foot">
                    <button type="button" id="edit-submit-changes" class="save-btn">Submit Changes</button>
                    <button type="button" onclick="closeEditOrderInfoPopup()" class="cancel-btn">Close</button>
                </div>
            </div>
        </div>

        <div id="edit-spinner-loader" class="loader-container" role="alert" aria-live="assertive" aria-busy="true">
            <div class="spinner-wheel"></div>
            <p>Loading...</p>
        </div>

<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
<script>
let EDIT_ORDER_COLLECTION = [];
let EDIT_CURRENT_ORDER = null;
let EDIT_MODIFIED_ORDERS = new Map();
let EDIT_CUSTOMER_NAMES = [];
let EDIT_GRADES = [];

function initializeEditableOrderData() {
    console.log('Initializing editable data...');
    showEditLoadingSpinner();
    google.script.run
        .withSuccessHandler(function(data) {
            console.log('Data received:', data);
            EDIT_ORDER_COLLECTION = data;
            populateEditableOrderGrid(EDIT_ORDER_COLLECTION);
            hideEditLoadingSpinner();
            fetchEditDropdownData();
        })
        .withFailureHandler(function(error) {
            console.error('Failed to load data:', error);
            alert('Failed to load data. Please refresh the page.');
            hideEditLoadingSpinner();
        })
        .getmasterData();
}

function fetchEditDropdownData() {
    google.script.run.withSuccessHandler(function(customers) {
        console.log('Fetched customers:', customers);
        EDIT_CUSTOMER_NAMES = customers;
        populateEditCustomerSuggestions();
    }).getCustomerNames();

    google.script.run.withSuccessHandler(function(grades) {
        console.log('Fetched grades:', grades);
        EDIT_GRADES = grades;
        populateEditGradeDropdowns();
    }).getGrades();
}

function populateEditCustomerSuggestions() {
    const customerInput = document.getElementById('edit-customer-name-search');
    const datalistId = 'edit-customer-name-suggestions';

    let datalist = document.getElementById(datalistId);
    if (!datalist) {
        datalist = document.createElement('datalist');
        datalist.id = datalistId;
        document.body.appendChild(datalist);
    }

    datalist.innerHTML = EDIT_CUSTOMER_NAMES
        .filter(customer => customer)
        .map(customer => `<option value="${customer}">`)
        .join('');

    customerInput.setAttribute('list', datalistId);
}

function populateEditGradeDropdowns() {
    const gradeInputs = document.querySelectorAll('select[name^="edit_grade_"]');

    gradeInputs.forEach(select => {
        select.innerHTML = '';

        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Select Grade';
        select.appendChild(defaultOption);

        EDIT_GRADES.forEach(grade => {
            const option = document.createElement('option');
            option.value = grade;
            option.textContent = grade;
            
            if (select.dataset.selectedGrade && select.dataset.selectedGrade === grade) {
                option.selected = true;
            }

            select.appendChild(option);
        });
    });
}

function populateEditableOrderGrid(data) {
    console.log('Populating editable grid with data:', data);
    const orderGrid = document.getElementById('editable-orders-table').getElementsByTagName('tbody')[0];
    orderGrid.innerHTML = '';

    if (!Array.isArray(data) || data.length === 0) {
        const noDataRow = orderGrid.insertRow();
        const noDataCell = noDataRow.insertCell();
        noDataCell.colSpan = 7;
        noDataCell.textContent = 'No data available';
        noDataCell.style.textAlign = 'center';
        noDataCell.style.color = 'red';
        return;
    }

    const statusSelector = document.getElementById('edit-status-filter').value;

    const filteredData = data.filter(row => {
        if (!row || row.length < 15) return false;
        const status = (row[14] || '').toString().trim().toLowerCase();
        return statusSelector === 'All' || 
               (statusSelector.toLowerCase() === 'open' && status === 'open') ||
               (statusSelector.toLowerCase() === 'close' && status === 'close');
    });

    const uniqueOrders = {};
    filteredData.forEach(row => {
        if (!row[0]) return;
        const orderId = row[0].toString();
        if (!uniqueOrders[orderId]) {
            uniqueOrders[orderId] = [row];
        } else {
            uniqueOrders[orderId].push(row);
        }
    });

    Object.keys(uniqueOrders).forEach(orderId => {
        const orderRows = uniqueOrders[orderId];
        const rowData = orderRows[0];
        
        const newRow = orderGrid.insertRow();
        
        // Add data cells
        const cells = [
            { index: 0, value: rowData[0] || '' },
            { index: 1, value: rowData[1] || '' },
            { index: 2, value: rowData[2] || '' },
            { index: 8, value: rowData[8] || '' },
            { index: 9, value: rowData[9] || '' },
            { index: 11, value: rowData[11] || '' }
        ];

        cells.forEach(cell => {
            const newCell = newRow.insertCell();
            newCell.textContent = cell.value;
        });

        const actionsCell = newRow.insertCell();
        const viewEditBtn = document.createElement('button');
        viewEditBtn.textContent = 'View/Edit';
        viewEditBtn.className = 'edit-view-btn';
        viewEditBtn.onclick = () => displayEditOrderDetails(orderRows, orderId);
        actionsCell.appendChild(viewEditBtn);
    });
}

function displayEditOrderDetails(orderDetails, orderId) {
    EDIT_CURRENT_ORDER = orderId;
    const modalTitle = document.getElementById('edit-order-info-title');
    const modalContainer = document.getElementById('edit-order-info-form');

    const activeOrderDetails = orderDetails.filter(detail => 
        detail && detail.length > 14 && detail[14] && detail[14].toString().trim() !== ''
    );

    if (activeOrderDetails.length === 0) {
        alert('No details available for this order');
        return;
    }

    const headerInfo = activeOrderDetails[0];
    const customerOptions = EDIT_CUSTOMER_NAMES.map(customer => 
        `<option value="${customer}">${customer}</option>`).join('');

    const headerHTML = `
        <div class="details-header">
            <div class="info-grid">
                <p><strong>Order ID:</strong> ${headerInfo[0]}</p>
                <p>
                    <strong>Customer Name:</strong>
                    <select id="edit-customer-name" name="customerName" class="editable-input">
                        <option value="">Select Customer</option>
                        ${customerOptions}
                    </select>
                </p>
                <p><strong>Issue Date:</strong> <input type="date" name="issueDate" value="${formatDateForInput(headerInfo[8])}" class="editable-input"></p>
                <p><strong>Delivery Date:</strong> <input type="date" name="deliveryDate" value="${formatDateForInput(headerInfo[9])}" class="editable-input"></p>
                <p><strong>Order Received Date:</strong> <input type="date" name="receivedDate" value="${formatDateForInput(headerInfo[11])}" class="editable-input"></p>
                <p><strong>Remarks:</strong> <input type="text" name="remarks" value="${headerInfo[10] || ''}" class="editable-input"></p>
            </div>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Size</th>
                    <th>Tolerance</th>
                    <th>Grade</th>
                    <th>Quantity Requested</th>
                    <th>Rate</th>
                    <th>Hb/HHb</th>
                </tr>
            </thead>
            <tbody>
                ${activeOrderDetails.map((detail, index) => `
                    <tr data-row-index="${index}">
                        <td><input type="text" name="edit_size_${index}" value="${detail[3] || ''}" class="editable-input"></td>
                        <td><input type="text" name="edit_tolerance_${index}" value="${detail[4] || ''}" class="editable-input"></td>
                        <td><select name="edit_grade_${index}" id="edit_grade_${index}" class="editable-input" data-selected-grade="${detail[5] || ''}">
                            <option value="">Select Grade</option>
                            ${EDIT_GRADES.map(grade => `<option value="${grade}"${detail[5] === grade ? ' selected' : ''}>${grade}</option>`).join('')}
                        </select></td>
                        <td><input type="number" name="edit_quantityRequested_${index}" value="${detail[6] || ''}" class="editable-input"></td>
                        <td><input type="number" name="edit_rate_${index}" value="${detail[15] || ''}" class="editable-input"></td>
                        <td><input type="text" name="edit_hbhhb_${index}" value="${detail[7] || ''}" class="editable-input"></td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;

    modalContainer.innerHTML = headerHTML;
    modalTitle.textContent = `Edit Order Details - Order ID: ${orderId}`;
    document.getElementById('edit-order-info-popup').style.display = 'block';
    document.getElementById('edit-order-info-popup').setAttribute('aria-hidden', 'false');

    const firstField = modalContainer.querySelector('.editable-input');
    if (firstField) {
        firstField.focus();
    }

    const editableFields = modalContainer.querySelectorAll('.editable-input');
    editableFields.forEach(field => {
        field.addEventListener('change', () => {
            const formData = new FormData(document.getElementById('edit-order-info-form'));
            const updatedData = Object.fromEntries(formData.entries());
            EDIT_MODIFIED_ORDERS.set(EDIT_CURRENT_ORDER, updatedData);
        });
    });
}

function formatDateForInput(dateString) {
    if (!dateString) return '';
    try {
        const parts = dateString.toString().split('/');
        if (parts.length !== 3) return dateString;
        return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
    } catch (error) {
        console.error('Date formatting error:', error);
        return '';
    }
}

function showEditLoadingSpinner() {
    document.getElementById('edit-spinner-loader').style.display = 'flex';
}

function hideEditLoadingSpinner() {
    document.getElementById('edit-spinner-loader').style.display = 'none';
}

function filterEditOrders() {
    const orderIdFilter = document.getElementById('edit-order-id-search').value.toLowerCase();
    const customerNameFilter = document.getElementById('edit-customer-name-search').value.toLowerCase();
    const statusFilter = document.getElementById('edit-status-filter').value.toLowerCase();

    const filteredData = EDIT_ORDER_COLLECTION.filter(row => {
        if (!row || row.length < 15) return false;
        const orderId = (row[0] || '').toString().toLowerCase();
        const customerName = (row[2] || '').toString().toLowerCase();
        const status = (row[14] || '').toString().toLowerCase();

        return (orderId.includes(orderIdFilter) || orderIdFilter === '') &&
               (customerName.includes(customerNameFilter) || customerNameFilter === '') &&
               (statusFilter === 'all' || status === statusFilter);
    });

    populateEditableOrderGrid(filteredData);
}

function refreshEditableOrderData() {
    initializeEditableOrderData();
}

function closeEditOrderInfoPopup() {
    const modalContainer = document.getElementById('edit-order-info-popup');
    modalContainer.style.display = 'none';
    modalContainer.setAttribute('aria-hidden', 'true');

    const modalForm = document.getElementById('edit-order-info-form');
    if (modalForm) {
        modalForm.reset();
    }

    const modalTitle = document.getElementById('edit-order-info-title');
    if (modalTitle) {
        modalTitle.textContent = '';
    }

    document.body.focus();
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing editable dashboard...');
    initializeEditableOrderData();
    
    // Add event listeners
    document.getElementById('edit-order-id-search').addEventListener('input', 
        _.debounce(() => filterEditOrders(), 300));
    document.getElementById('edit-customer-name-search').addEventListener('input', 
        _.debounce(() => filterEditOrders(), 300));
    document.getElementById('edit-status-filter').addEventListener('change', 
        _.debounce(() => filterEditOrders(), 300));
    document.getElementById('edit-refresh-data').addEventListener('click', refreshEditableOrderData);
    
    // Submit changes event listener
    document.getElementById('edit-submit-changes').addEventListener('click', function() {
        if (EDIT_MODIFIED_ORDERS.size === 0) {
            alert('No changes to submit');
            return;
        }

        showEditLoadingSpinner();

        const submissionData = Array.from(EDIT_MODIFIED_ORDERS.entries()).map(([orderId, data]) => {
            const originalOrder = EDIT_ORDER_COLLECTION.find(order => order[0] === orderId);
            return {
                orderId,
                ...data,
                originalData: originalOrder
            };
        });

        google.script.run
            .withSuccessHandler(function(response) {
                console.log('Response:', response);
                EDIT_MODIFIED_ORDERS.clear();
                refreshEditableOrderData();
                hideEditLoadingSpinner();
                showNotification('Changes submitted successfully!', 'success');
            })
            .withFailureHandler(function(error) {
                console.error('Submission error:', error);
                hideEditLoadingSpinner();
                showNotification('Failed to submit changes.', 'error');
            })
            .submitOrderUpdates(submissionData);
    });
});

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `alert-message ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script></div>



</div>
    <script>
        function switchTab(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active state from all buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Set active state on clicked button
            event.currentTarget.classList.add('active');
        }

        // Initialize first tab as active
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('section1').classList.add('active');
        });

      function toggleDropdown(id) {
        var dropdown = document.getElementById(id);
        dropdown.style.display = (dropdown.style.display === "none" || dropdown.style.display === "") ? "block" : "none";
        }
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show the selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Update active state in sidebar
            document.querySelectorAll('.sidebar a').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('onclick').includes(sectionId)) {
                    link.classList.add('active');
                }
            });
        }
    </script>
</body>
</html>
